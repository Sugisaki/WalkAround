# バックグラウンド計測とロジック

WalkAround の中心機能である位置情報と歩数の計測、およびそれらに付随する自動案内ロジックについて解説します。

## 1. TrackingService の役割

`TrackingService` は、アプリがバックグラウンドにある状態でも計測を継続するための **Foreground Service** です。
-   **Service Type**: `location` (位置情報) および `health` (身体活動/歩数)。
-   **ライフサイクル**: ユーザーが「開始」ボタンを押すと `startForeground` で常駐を開始し、「停止」ボタンで終了します。

## 2. 位置情報計測とフィルタリング

`LocationManager` を通じて `FusedLocationProviderClient` から位置情報を取得します。

### 精度フィルタリング
GPSの誤差による「位置の飛び」を防ぐため、以下のロジックを適用しています。
-   **精度制限 (`accuracyLimit`)**: 設定画面で変更可能（デフォルト 20m）。この値より精度の低い（誤差が大きい）座標は、住所変換や案内ロジックの対象外となります。
-   **最新地点の保持**: 精度条件を満たした最新の座標を常にメモリに保持し、後述する住所チェック処理で使用します。

## 3. 歩数計測 (Step Counting)

`StepSensorManager` を使用して、デバイスのハードウェア歩数センサー（TYPE_STEP_COUNTER）から値を取得します。
-   計測開始時のセンサー値を基準とし、差分を現在のセッションの歩数としてカウントします。
-   取得した歩数は `StepSegment` として DB に保存されます。

## 4. 住所変換と自動記録 (ハイブリッド駆動)

住所の記録は、時間と距離の両面から監視を行うことで、あらゆる移動状況（静止・歩行・高速移動）で取りこぼしがないように設計されています。

### 変化検知のロジック
住所の変化（丁目レベル）を判定するために、取得した住所オブジェクトから比較用のキーを生成します。
-   **比較キーの構成**: `郵便番号 + 市区町村 + 町村 + 丁目/番地`
-   **郵便番号の重要性**: 同一市内の異なる区（政令指定都市など）で、同じ町名や丁目が存在する場合でも、郵便番号を含めることで正確に「場所の変化」として検知できるようにしています。

### 保存とチェックのトリガー
1.  **開始時 (即時)**: 計測開始直後に取得した精度の高い座標を、即座に住所変換して保存・案内します。
2.  **定期タイマー (1分ごと)**: 
    -   1分間隔で「最新の有効な座標」をチェックします。
    -   前回のチェック地点から **5m 以上の移動** があれば住所取得（ジオコーディング）を試みます。
3.  **距離割り込み (200mごと)**:
    -   1分を待たずとも、前回のチェック地点から **200m 以上移動** した瞬間に即座にチェックを実行します。これにより高速移動中の取りこぼしを防ぎます。
4.  **終了時 (即時)**: 計測停止時の座標を保存します。

### 信頼性を高めるロジック (リトライと最適化)
-   **失敗時のリトライ**: 通信エラー等で住所取得に失敗（null）した場合、チェック地点を更新しません。これにより次回のタイマー（1分後）で即座に再試行が行われます。
-   **未確定地点の優先**: 現在の場所に留まっていても、その場所で一度も住所の取得に成功していない場合は、5m の距離制限を無視してアグレッシブに取得を試みます。
-   **API呼び出しの集約**: 取得した `Address` オブジェクトを DB保存と音声案内の両方で使い回し、重複した API アクセスを排除しています。

## 5. 音声案内 (Text-to-Speech)

`TextToSpeechHelper` を使用し、以下の状況で案内を行います。

| タイミング | 読み上げ内容 |
| :--- | :--- |
| **計測開始** | 「計測を開始しました。現在地は [市区町村・地番] です。」 |
| **住所（丁目）変化** | [新しく到達した住所（市区町村・地番）] |
| **計測終了** | 「計測を終了しました。お疲れ様でした。」 |

※ 生成した比較キーが変化した場合のみ案内を行います。
