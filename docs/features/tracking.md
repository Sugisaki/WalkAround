# バックグラウンド計測とロジック

WalkAround の中心機能である位置情報と歩数の計測、およびそれらに付随する自動案内ロジックについて解説します。

## 1. TrackingService の役割

`TrackingService` は、アプリがバックグラウンドにある状態でも計測を継続するための **Foreground Service** です。
-   **Service Type**: `location` (位置情報) および `health` (身体活動/歩数)。
-   **ライフサイクル**: ユーザーが「開始」ボタンを押すと `startForeground` で常駐を開始し、「停止」ボタンで終了します。

## 2. 位置情報計測とフィルタリング

`LocationManager` を通じて `FusedLocationProviderClient` から位置情報を取得します。

### 精度フィルタリング
GPSの誤差による「位置の飛び」を防ぐため、以下のロジックを適用しています。
-   **精度制限 (`accuracyLimit`)**: 設定画面で変更可能（デフォルト 20m）。この値より精度の低い（誤差が大きい）座標は、住所変換や案内ロジックの対象外となります。
-   **更新間隔**: 1秒（最小距離 2m）。

## 3. 歩数計測 (Step Counting)

`StepSensorManager` を使用して、デバイスのハードウェア歩数センサー（TYPE_STEP_COUNTER）から値を取得します。
-   計測開始時のセンサー値を基準とし、差分を現在のセッションの歩数としてカウントします。
-   取得した歩数は `StepSegment` として DB に保存されます。

## 4. 住所変換と自動記録

計測中、特定のタイミングで座標を住所（逆ジオコーディング）に変換し、記録します。

### 保存のタイミング
1.  **開始時**: 計測開始直後の座標を住所に変換し、最初の記録として保存。
2.  **移動時 (丁目変化検知)**: 最後に保存した住所から「丁目レベル（`Thoroughfare`）」が変化した場合に自動保存。
    -   API 負荷軽減のため、前回のチェックから一定時間（`Constants.ADDRESS_PROCESS_INTERVAL_MS` = 1分）経過している場合にのみ判定を行います。
3.  **終了時**: 計測停止時の最新の（精度の高い）座標を住所に変換して保存。

## 5. 音声案内 (Text-to-Speech)

`TextToSpeechHelper` を使用し、以下の状況でユーザーに音声で案内を行います。

| タイミング | 読み上げ内容 |
| :--- | :--- |
| **計測開始** | 「計測を開始しました。現在地は [市区町村・地番] です。」 |
| **住所変化** | [新しく到達した住所（市区町村・地番）] |
| **計測終了** | 「計測を終了しました。お疲れ様でした。」 |

※ 設定画面で「音声案内」がオフの場合は、読み上げは行われません。
